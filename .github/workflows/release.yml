name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ${{ github.repository }}/backend
  FRONTEND_IMAGE: ${{ github.repository }}/frontend

jobs:
  generate-tags:
    name: Generate Release Tags
    runs-on: ubuntu-latest
    outputs:
      backend_tags: ${{ steps.tags.outputs.backend_tags }}
      frontend_tags: ${{ steps.tags.outputs.frontend_tags }}
    steps:
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Generate image tags
        id: tags
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          BACKEND_TAGS="${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:v${VERSION},${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest,${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:production"
          FRONTEND_TAGS="${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:v${VERSION},${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest,${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:production"

          echo "backend_tags=${BACKEND_TAGS}" >> $GITHUB_OUTPUT
          echo "frontend_tags=${FRONTEND_TAGS}" >> $GITHUB_OUTPUT
          echo "Generated tags:"
          echo "Backend: ${BACKEND_TAGS}"
          echo "Frontend: ${FRONTEND_TAGS}"

  build-backend:
    name: Build and Push Backend Image
    needs: generate-tags
    uses: ./.github/workflows/reusable-build-push-docker.yml
    with:
      service: backend
      dockerfile: ./packages/backend/Dockerfile
      target: production
      image-name: ghcr.io/${{ github.repository }}/backend
      tags: ${{ needs.generate-tags.outputs.backend_tags }}
      cache-scope: backend-release

  build-frontend:
    name: Build and Push Frontend Image
    needs: generate-tags
    uses: ./.github/workflows/reusable-build-push-docker.yml
    with:
      service: frontend
      dockerfile: ./packages/frontend/Dockerfile
      target: nginx
      image-name: ghcr.io/${{ github.repository }}/frontend
      tags: ${{ needs.generate-tags.outputs.frontend_tags }}
      cache-scope: frontend-release

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [generate-tags, build-backend, build-frontend]
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: ${VERSION}"

      - name: Generate release notes
        id: release-notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" ${PREVIOUS_TAG}..HEAD)
          fi

          NOTES="## Release v${VERSION}

          ### Docker Images (Multi-Arch: linux/amd64, linux/arm64)

          **Backend:**
          \`\`\`
          ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:v${VERSION}
          ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:latest
          ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:production
          \`\`\`

          **Frontend:**
          \`\`\`
          ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:v${VERSION}
          ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:latest
          ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:production
          \`\`\`

          ### Changes

          ${CHANGELOG}
          "

          echo "${NOTES}" > release-notes.md
          echo "notes<<EOF" >> $GITHUB_OUTPUT
          echo "${NOTES}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@6da8fa9354ddfdc4aeace5fc48d7f679b5214090 # v2.4.1
        with:
          tag_name: ${{ github.ref_name }}
          name: Release v${{ steps.version.outputs.version }}
          body_path: release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
